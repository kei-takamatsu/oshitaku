<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åì„Å©„ÇÇ„Åä„Åó„Åü„Åè„Ç¢„Éó„É™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const App = () => {
            const defaultTasks = [
                { id: 'm1', text: '„Åã„Åä„Çí„ÅÇ„Çâ„ÅÜ', icon: 'üí¶', time: 'morning', done: false },
                { id: 'm2', text: '„ÅØ„Åø„Åå„Åç', icon: 'ü™•', time: 'morning', done: false },
                { id: 'm3', text: '„Åç„Åå„Åà', icon: 'üëï', time: 'morning', done: false },
                { id: 'm4', text: '„Éà„Ç§„É¨', icon: 'üöΩ', time: 'morning', done: false },
                { id: 'e1', text: '„Å¶„ÅÇ„Çâ„ÅÑ„Éª„ÅÜ„Åå„ÅÑ', icon: 'üßº', time: 'evening', done: false },
                { id: 'e2', text: '„Åä„Åµ„Çç', icon: 'üõÅ', time: 'evening', done: false },
                { id: 'e3', text: '„ÅØ„Åø„Åå„Åç', icon: 'ü™•', time: 'evening', done: false },
                { id: 'e4', text: '„Éà„Ç§„É¨', icon: 'üöΩ', time: 'evening', done: false },
                { id: 'e5', text: '„Åó„ÇÖ„Åè„Å†„ÅÑ', icon: 'üìö', time: 'evening', done: false },
                { id: 'e6', text: '„ÅÇ„Åó„Åü„ÅÆ„Çà„ÅÜ„ÅÑ', icon: 'üéí', time: 'evening', done: false },
            ];

            const [tasks, setTasks] = useState([]);
            const [history, setHistory] = useState({});
            const [activeTab, setActiveTab] = useState('morning');
            const [view, setView] = useState('main'); 
            const [showConfetti, setShowConfetti] = useState(false);
            const [editingDate, setEditingDate] = useState(null); // ÈÅéÂéªÁ∑®ÈõÜÁî®

            const getTodayStr = () => new Date().toDateString();
            const getTodayKey = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            };

            const getProperTab = useCallback(() => {
                const hour = new Date().getHours();
                return (hour >= 5 && hour < 15) ? 'morning' : 'evening';
            }, []);

            // ÂàùÊúüÂåñ
            useEffect(() => {
                const savedTasks = localStorage.getItem('kidsTasksV5');
                const savedHistory = localStorage.getItem('kidsHistoryV5');
                const savedDate = localStorage.getItem('taskDateV5');
                const todayStr = getTodayStr();

                if (savedTasks) {
                    const parsed = JSON.parse(savedTasks);
                    setTasks(savedDate !== todayStr ? parsed.map(t => ({ ...t, done: false })) : parsed);
                } else {
                    setTasks(defaultTasks);
                }
                if (savedHistory) setHistory(JSON.parse(savedHistory));
                localStorage.setItem('taskDateV5', todayStr);
                setActiveTab(getProperTab());

                const timer = setInterval(() => {
                    const target = getProperTab();
                    setActiveTab(prev => (prev !== target ? target : prev));
                }, 60000);
                return () => clearInterval(timer);
            }, []);

            // ‰øùÂ≠ò
            useEffect(() => {
                if (tasks.length > 0) {
                    localStorage.setItem('kidsTasksV5', JSON.stringify(tasks));
                    const done = tasks.filter(t => t.done).length;
                    const percent = Math.round((done / tasks.length) * 100);
                    const newHistory = { ...history, [getTodayKey()]: percent };
                    setHistory(newHistory);
                    localStorage.setItem('kidsHistoryV5', JSON.stringify(newHistory));
                }
            }, [tasks]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, activeTab, tasks, editingDate]);

            const toggleTask = (id) => {
                const newTasks = tasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
                if (newTasks.filter(t => t.time === activeTab).every(t => t.done) && 
                    !tasks.filter(t => t.time === activeTab).every(t => t.done)) {
                    setShowConfetti(true);
                }
                setTasks(newTasks);
            };

            const updateHistoryManually = (dateStr, percent) => {
                const newHistory = { ...history, [dateStr]: percent };
                setHistory(newHistory);
                localStorage.setItem('kidsHistoryV5', JSON.stringify(newHistory));
                setEditingDate(null);
            };

            const stats = useMemo(() => {
                const items = Object.entries(history);
                const completedDays = items.filter(([_, v]) => v === 100).length;
                const avgPercent = items.length > 0 ? Math.round(items.reduce((s, [_, v]) => s + v, 0) / items.length) : 0;
                return { completedDays, avgPercent };
            }, [history]);

            const StatsView = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                return (
                    <div className="p-4 space-y-6 animate-pop pb-24">
                        <div className="flex justify-between items-center">
                            <button onClick={() => setView('main')} className="p-2 bg-white rounded-full shadow-md"><i data-lucide="chevron-left"></i></button>
                            <h2 className="text-xl font-bold text-purple-600 italic">GANBARI-HYO</h2>
                            <div className="w-10"></div>
                        </div>

                        <div className="bg-white rounded-3xl p-5 shadow-sm flex justify-around text-center">
                            <div><p className="text-[10px] text-slate-400 font-bold uppercase">Average</p><p className="text-2xl font-black text-purple-500">{stats.avgPercent}%</p></div>
                            <div className="w-px bg-slate-100"></div>
                            <div><p className="text-[10px] text-slate-400 font-bold uppercase">Perfect</p><p className="text-2xl font-black text-orange-400">{stats.completedDays}Êó•</p></div>
                        </div>

                        <div className="bg-white rounded-3xl p-5 shadow-sm">
                            <h3 className="font-bold text-green-600 mb-4 flex items-center gap-1"><i data-lucide="calendar" className="w-4 h-4"></i> „Ç´„É¨„É≥„ÉÄ„ÉºÔºà„Çø„ÉÉ„Éó„Åß„Å™„Åä„Åõ„Çã„ÇàÔºâ</h3>
                            <div className="calendar-grid">
                                {['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].map(d => <div key={d} className="text-center text-[10px] text-slate-300 py-1">{d}</div>)}
                                {Array(firstDay).fill(null).map((_, i) => <div key={`e-${i}`}></div>)}
                                {Array(daysInMonth).fill(null).map((_, i) => {
                                    const day = i + 1;
                                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const perf = history[dateStr] || 0;
                                    return (
                                        <div key={day} onClick={() => setEditingDate({dateStr, day})} className={`aspect-square rounded-xl flex items-center justify-center relative border transition-all active:scale-90 ${dateStr === getTodayKey() ? 'border-purple-400 bg-purple-50' : 'border-slate-50 hover:bg-slate-50'}`}>
                                            <span className={`text-[10px] ${dateStr === getTodayKey() ? 'text-purple-600 font-bold' : 'text-slate-400'}`}>{day}</span>
                                            {perf === 100 && <div className="absolute inset-0 flex items-center justify-center text-orange-400 opacity-70 text-lg">üíÆ</div>}
                                            {perf > 0 && perf < 100 && <div className="absolute bottom-1 w-1 h-1 bg-green-300 rounded-full"></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            const currentList = tasks.filter(t => t.time === activeTab);
            const progress = currentList.length > 0 ? Math.round((currentList.filter(t => t.done).length / currentList.length) * 100) : 0;

            return (
                <div className="min-h-screen bg-slate-50 select-none">
                    {view === 'stats' ? <StatsView /> : (
                        <div className="pb-24">
                            <div className={`p-4 shadow-lg sticky top-0 z-10 rounded-b-[40px] transition-colors safe-area-top ${activeTab === 'morning' ? 'bg-sky-400' : 'bg-purple-400'}`}>
                                <div className="flex justify-between items-center text-white mb-3">
                                    <h1 className="text-xl font-bold">„Åä„Åó„Åü„Åè„Çπ„Çø„Éº</h1>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('stats')} className="p-2 rounded-full bg-white/20"><i data-lucide="trophy"></i></button>
                                    </div>
                                </div>
                                <div className="bg-white/30 rounded-full h-4 overflow-hidden"><div className="bg-yellow-300 h-full transition-all duration-700" style={{ width: `${progress}%` }} /></div>
                            </div>

                            <div className="flex gap-4 my-4 px-6">
                                <button onClick={() => setActiveTab('morning')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'morning' ? 'bg-sky-50 border-sky-400 text-sky-600 font-bold' : 'bg-white border-transparent text-slate-300'}`}>„ÅÇ„Åï</button>
                                <button onClick={() => setActiveTab('evening')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'evening' ? 'bg-purple-50 border-purple-400 text-purple-600 font-bold' : 'bg-white border-transparent text-slate-300'}`}>„Çà„Çã</button>
                            </div>

                            <div className="px-4 space-y-4">
                                {currentList.map(task => (
                                    <div key={task.id} onClick={() => toggleTask(task.id)} className={`p-5 rounded-[32px] flex items-center gap-4 bg-white shadow-sm border-b-4 border-slate-200 active:scale-95 transition-all ${task.done ? 'opacity-60 bg-green-50' : ''}`}>
                                        <div className="text-4xl">{task.icon}</div>
                                        <div className={`flex-1 font-bold text-lg ${task.done ? 'line-through text-green-700' : ''}`}>{task.text}</div>
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${task.done ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-200'}`}>
                                            {task.done && <i data-lucide="check" className="w-6 h-6 stroke-[4]"></i>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* ÈÅéÂéªÂÖ•ÂäõÁî®„É¢„Éº„ÉÄ„É´ */}
                    {editingDate && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm" onClick={() => setEditingDate(null)}>
                            <div className="bg-white w-full max-w-xs p-6 rounded-[40px] animate-pop shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-center font-bold text-slate-600 mb-6">{editingDate.day}„Å´„Å° „ÅÆ „Åä„Åó„Åü„Åè</h3>
                                <div className="space-y-3">
                                    <button onClick={() => updateHistoryManually(editingDate.dateStr, 100)} className="w-full py-4 bg-orange-50 text-orange-600 font-bold rounded-2xl border-2 border-orange-200 flex items-center justify-center gap-2">
                                        <span className="text-2xl">üíÆ</span> „Åú„Çì„Å∂ „Åß„Åç„ÅüÔºÅ
                                    </button>
                                    <button onClick={() => updateHistoryManually(editingDate.dateStr, 50)} className="w-full py-4 bg-green-50 text-green-600 font-bold rounded-2xl border-2 border-green-200 flex items-center justify-center gap-2">
                                        <span className="text-lg">‚óè</span> „ÅØ„Çì„Å∂„Çì „Åß„Åç„Åü
                                    </button>
                                    <button onClick={() => updateHistoryManually(editingDate.dateStr, 0)} className="w-full py-4 bg-slate-50 text-slate-400 font-bold rounded-2xl border-2 border-slate-200">
                                        „Åæ„Å† / „ÇÑ„Å£„Å¶„ÅÑ„Å™„ÅÑ
                                    </button>
                                    <button onClick={() => setEditingDate(null)} className="w-full py-3 text-slate-400 text-sm mt-2">„ÇÇ„Å©„Çã</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfetti && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6" onClick={() => setShowConfetti(false)}>
                            <div className="bg-white w-full max-w-xs p-8 rounded-[50px] text-center animate-pop">
                                <h2 className="text-3xl font-black text-sky-600 mb-4">üíÆ „ÅØ„Å™„Åæ„ÇãÔºÅ</h2>
                                <p className="font-bold text-slate-500 mb-6">„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ</p>
                                <button onClick={() => setShowConfetti(false)} className="w-full bg-yellow-400 text-white font-black py-4 rounded-2xl">„ÇÑ„Å£„Åü„ÉºÔºÅ</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
