<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åä„Åó„Åü„Åè„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [history, setHistory] = useState({});
            const [activeTab, setActiveTab] = useState('morning');
            const [view, setView] = useState('main'); 
            const [showConfetti, setShowConfetti] = useState(false);
            const [editingDate, setEditingDate] = useState(null);
            const [newTaskText, setNewTaskText] = useState('');
            const [newTaskIcon, setNewTaskIcon] = useState('‚ú®');

            const iconOptions = ['‚ú®', 'üí¶', 'ü™•', 'üëï', 'üöΩ', 'üçö', 'üßº', 'üõÅ', 'üõå', 'üìö', 'üéí', 'üëü', '‚úèÔ∏è', 'üçé'];

            const getTodayStr = () => new Date().toDateString();
            const getTodayKey = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            };
            const getProperTab = useCallback(() => {
                const hour = new Date().getHours();
                return (hour >= 5 && hour < 15) ? 'morning' : 'evening';
            }, []);

            useEffect(() => {
                const savedTasks = localStorage.getItem('kidsTasksV8');
                const savedHistory = localStorage.getItem('kidsHistoryV8');
                const savedDate = localStorage.getItem('taskDateV8');
                const todayStr = getTodayStr();

                if (savedTasks) {
                    const parsed = JSON.parse(savedTasks);
                    setTasks(savedDate !== todayStr ? parsed.map(t => ({ ...t, done: false })) : parsed);
                } else {
                    setTasks([
                        { id: '1', text: '„Åã„Åä„Çí„ÅÇ„Çâ„ÅÜ', icon: 'üí¶', time: 'morning', done: false },
                        { id: '2', text: '„ÅØ„Åø„Åå„Åç', icon: 'ü™•', time: 'morning', done: false },
                        { id: '3', text: '„Åä„Åµ„Çç', icon: 'üõÅ', time: 'evening', done: false },
                        { id: '4', text: '„Åó„ÇÖ„Åè„Å†„ÅÑ', icon: 'üìö', time: 'evening', done: false }
                    ]);
                }
                if (savedHistory) setHistory(JSON.parse(savedHistory));
                localStorage.setItem('taskDateV8', todayStr);
                setActiveTab(getProperTab());
            }, []);

            const refreshAppState = useCallback(() => {
                const todayStr = getTodayStr();
                const savedDate = localStorage.getItem('taskDateV8');
                const targetTab = getProperTab();

                if (savedDate !== todayStr) {
                    setTasks(prev => prev.map(t => ({ ...t, done: false })));
                    localStorage.setItem('taskDateV8', todayStr);
                }
                setActiveTab(prev => (prev !== targetTab ? targetTab : prev));
            }, [getProperTab]);

            useEffect(() => {
                const timer = setInterval(refreshAppState, 60000);
                window.addEventListener('focus', refreshAppState);
                return () => {
                    clearInterval(timer);
                    window.removeEventListener('focus', refreshAppState);
                };
            }, [refreshAppState]);

            useEffect(() => {
                if (tasks.length > 0) {
                    localStorage.setItem('kidsTasksV8', JSON.stringify(tasks));
                    const done = tasks.filter(t => t.done).length;
                    const percent = Math.round((done / tasks.length) * 100);
                    const newHistory = { ...history, [getTodayKey()]: percent };
                    setHistory(newHistory);
                    localStorage.setItem('kidsHistoryV8', JSON.stringify(newHistory));
                }
            }, [tasks]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, activeTab, tasks, editingDate]);

            const stats = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                const monthHistory = Object.entries(history).filter(([key]) => key.startsWith(`${currentYear}-${String(currentMonth).padStart(2, '0')}`));
                const completedDays = monthHistory.filter(([_, val]) => val === 100).length;
                const avgPercent = monthHistory.length > 0 ? Math.round(monthHistory.reduce((s, [_, v]) => s + v, 0) / monthHistory.length) : 0;
                const fiscalYear = currentMonth >= 4 ? currentYear : currentYear - 1;
                const chartData = [];
                for (let i = 0; i < 12; i++) {
                    const m = (4 + i - 1) % 12 + 1;
                    const y = (4 + i) <= 12 ? fiscalYear : fiscalYear + 1;
                    const prefix = `${y}-${String(m).padStart(2, '0')}`;
                    const items = Object.entries(history).filter(([key]) => key.startsWith(prefix));
                    const avg = items.length > 0 ? Math.round(items.reduce((s, [_, v]) => s + v, 0) / items.length) : 0;
                    chartData.push({ month: m, avg });
                }
                return { completedDays, avgPercent, chartData };
            }, [history]);

            const toggleTask = (id) => {
                const newTasks = tasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
                const currentTabTasks = tasks.filter(t => t.time === activeTab);
                const isNowComplete = newTasks.filter(t => t.time === activeTab).every(t => t.done);
                const wasComplete = currentTabTasks.every(t => t.done);
                if (isNowComplete && !wasComplete && currentTabTasks.length > 0) setShowConfetti(true);
                setTasks(newTasks);
            };

            const addTask = (time) => {
                if (!newTaskText.trim()) return;
                setTasks([...tasks, { id: Date.now().toString(), text: newTaskText, icon: newTaskIcon, time, done: false }]);
                setNewTaskText('');
            };

            const updateHistoryManually = (dateStr, percent) => {
                setHistory(prev => {
                    const next = { ...prev, [dateStr]: percent };
                    localStorage.setItem('kidsHistoryV8', JSON.stringify(next));
                    return next;
                });
                setEditingDate(null);
            };

            const currentList = tasks.filter(t => t.time === activeTab);
            const progress = currentList.length > 0 ? Math.round((currentList.filter(t => t.done).length / currentList.length) * 100) : 0;

            const StatsView = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                return (
                    <div className="p-4 space-y-6 animate-pop pb-24">
                        <div className="flex justify-between items-center">
                            <button onClick={() => setView('main')} className="p-2 bg-white rounded-full shadow-md"><i data-lucide="chevron-left"></i></button>
                            <h2 className="text-xl font-bold text-purple-600 tracking-tighter">„Åå„Çì„Å∞„Çä„Å≤„Çá„ÅÜ</h2>
                            <div className="w-10"></div>
                        </div>

                        <div className="bg-white rounded-3xl p-5 shadow-sm border-b-4 border-purple-100 flex justify-around text-center">
                            <div><p className="text-[10px] text-slate-400 font-bold">„Å∏„ÅÑ„Åç„Çì</p><p className="text-2xl font-black text-purple-500">{stats.avgPercent}%</p></div>
                            <div className="w-px bg-slate-100"></div>
                            <div><p className="text-[10px] text-slate-400 font-bold">„Éë„Éº„Éï„Çß„ÇØ„Éà</p><p className="text-2xl font-black text-orange-400">{stats.completedDays}<span className="text-xs ml-1 font-normal">„Å´„Å°</span></p></div>
                        </div>

                        <div className="bg-white rounded-3xl p-5 shadow-sm border-b-4 border-indigo-100">
                            <h3 className="font-bold text-indigo-600 mb-4 flex items-center gap-1 text-sm"><i data-lucide="bar-chart-3" className="w-4 h-4"></i> „Å§„Åç„Åπ„Å§„ÅÆ „Ç∞„É©„Éï</h3>
                            <div className="flex items-end justify-between h-24 px-1 gap-1">
                                {stats.chartData.map((d, i) => (
                                    <div key={i} className="flex-1 flex flex-col items-center gap-1">
                                        <div className="w-full bg-slate-50 rounded-t-md h-16 flex items-end overflow-hidden">
                                            <div className="w-full bg-purple-400" style={{ height: `${d.avg}%` }}></div>
                                        </div>
                                        <span className="text-[9px] font-bold text-slate-400">{d.month}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-3xl p-5 shadow-sm border-b-4 border-green-100">
                            <h3 className="font-bold text-green-600 mb-4 flex items-center gap-1 text-sm"><i data-lucide="calendar" className="w-4 h-4"></i> „Ç´„É¨„É≥„ÉÄ„ÉºÔºà„Çø„ÉÉ„Éó„Åó„Å¶ „Å™„Åä„Åõ„Çã„ÇàÔºâ</h3>
                            <div className="calendar-grid">
                                {['„Å´„Å°','„Åí„Å§','„Åã','„Åô„ÅÑ','„ÇÇ„Åè','„Åç„Çì','„Å©'].map(d => <div key={d} className="text-center text-[10px] text-slate-300 font-bold">{d}</div>)}
                                {Array(firstDay).fill(null).map((_, i) => <div key={`e-${i}`}></div>)}
                                {Array(daysInMonth).fill(null).map((_, i) => {
                                    const day = i + 1;
                                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const p = history[dateKey] || 0;
                                    return (
                                        <div key={day} onClick={() => setEditingDate({key: dateKey, day})} className={`aspect-square rounded-xl flex items-center justify-center relative border transition-all active:scale-90 ${dateKey === getTodayKey() ? 'border-purple-400 bg-purple-50' : 'border-slate-50'}`}>
                                            <span className={`text-[10px] ${dateKey === getTodayKey() ? 'text-purple-600 font-bold' : 'text-slate-400'}`}>{day}</span>
                                            {p === 100 && <div className="absolute inset-0 flex items-center justify-center text-orange-400 opacity-80 text-lg">üíÆ</div>}
                                            {p > 0 && p < 100 && <div className="absolute bottom-1 w-1 h-1 bg-green-300 rounded-full"></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 select-none">
                    {view === 'stats' ? <StatsView /> : view === 'edit' ? (
                        <div className="p-4 animate-pop pb-24">
                            <div className="flex justify-between items-center mb-6">
                                <button onClick={() => setView('main')} className="p-2 bg-white rounded-full shadow-md"><i data-lucide="chevron-left"></i></button>
                                <h2 className="text-xl font-bold text-sky-600">„Åõ„Å£„Å¶„ÅÑ</h2>
                                <div className="w-10"></div>
                            </div>
                            <div className="bg-white p-5 rounded-[32px] shadow-sm mb-6 border-b-4 border-sky-100">
                                <input type="text" value={newTaskText} onChange={e => setNewTaskText(e.target.value)} placeholder="„Å™„Å´„Çí„Åô„ÇãÔºü" className="w-full p-4 rounded-2xl bg-slate-50 mb-4 outline-none border-2 border-transparent focus:border-sky-300 font-bold" />
                                <div className="flex gap-2 overflow-x-auto mb-4 scrollbar-hide pb-2">
                                    {iconOptions.map(icon => <button key={icon} onClick={() => setNewTaskIcon(icon)} className={`text-2xl p-3 rounded-2xl ${newTaskIcon === icon ? 'bg-sky-100 ring-2 ring-sky-300' : 'bg-slate-50'}`}>{icon}</button>)}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => addTask('morning')} className="flex-1 py-4 bg-sky-400 text-white font-bold rounded-2xl shadow-md">„ÅÇ„Åï„Å´„Å§„ÅÑ„Åã</button>
                                    <button onClick={() => addTask('evening')} className="flex-1 py-4 bg-purple-400 text-white font-bold rounded-2xl shadow-md">„Çà„Çã„Å´„Å§„ÅÑ„Åã</button>
                                </div>
                            </div>
                            <div className="space-y-3">
                                {tasks.map(t => (
                                    <div key={t.id} className="flex items-center gap-3 bg-white p-4 rounded-2xl shadow-sm border-b-2 border-slate-100">
                                        <span className="text-2xl bg-slate-50 w-12 h-12 flex items-center justify-center rounded-xl">{t.icon}</span>
                                        <span className="flex-1 font-bold text-slate-600">{t.text} <span className="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 ml-1">{t.time === 'morning' ? '„ÅÇ„Åï' : '„Çà„Çã'}</span></span>
                                        <button onClick={() => { if(confirm('„Åë„ÅôÔºü')) setTasks(tasks.filter(x => x.id !== t.id)) }} className="text-red-300 p-2"><i data-lucide="trash-2" className="w-5 h-5"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="pb-24">
                            <div className={`p-4 shadow-lg sticky top-0 z-10 rounded-b-[40px] transition-colors safe-area-top ${activeTab === 'morning' ? 'bg-sky-400' : 'bg-purple-400'}`}>
                                <div className="flex justify-between items-center text-white mb-3 px-1">
                                    <h1 className="text-xl font-bold flex items-center gap-2"><i data-lucide="star" className="fill-yellow-300 text-yellow-300 w-5 h-5"></i>„Åä„Åó„Åü„Åè„Çπ„Çø„Éº</h1>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('stats')} className="p-2 bg-white/20 rounded-full active:scale-90"><i data-lucide="trophy" className="w-5 h-5"></i></button>
                                        <button onClick={() => setView('edit')} className="p-2 bg-white/20 rounded-full active:scale-90"><i data-lucide="settings" className="w-5 h-5"></i></button>
                                    </div>
                                </div>
                                <div className="bg-white/30 rounded-full h-4 overflow-hidden border border-white/10 px-0.5 flex items-center">
                                    <div className="bg-yellow-300 h-3 rounded-full transition-all duration-700" style={{ width: `${progress}%` }} />
                                </div>
                            </div>

                            <div className="flex gap-4 my-6 px-6">
                                <button onClick={() => setActiveTab('morning')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'morning' ? 'bg-sky-50 border-sky-400 text-sky-600 font-bold scale-105 shadow-sm' : 'bg-white border-transparent text-slate-300'}`}>„ÅÇ„Åï</button>
                                <button onClick={() => setActiveTab('evening')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'evening' ? 'bg-purple-50 border-purple-400 text-purple-600 font-bold scale-105 shadow-sm' : 'bg-white border-transparent text-slate-300'}`}>„Çà„Çã</button>
                            </div>

                            <div className="px-4 space-y-4 max-w-md mx-auto">
                                {currentList.map(task => (
                                    <div key={task.id} onClick={() => toggleTask(task.id)} className={`p-5 rounded-[32px] flex items-center gap-4 bg-white shadow-sm border-b-4 border-slate-200 active:scale-95 transition-all ${task.done ? 'opacity-60 bg-green-50' : ''}`}>
                                        <div className="text-4xl bg-slate-50 w-14 h-14 rounded-2xl flex items-center justify-center">{task.icon}</div>
                                        <div className={`flex-1 font-bold text-lg ${task.done ? 'line-through text-green-700' : 'text-slate-700'}`}>{task.text}</div>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${task.done ? 'bg-green-500 text-white shadow-lg shadow-green-200 scale-110' : 'bg-slate-100 text-slate-200'}`}>
                                            {task.done ? <i data-lucide="check" className="w-7 h-7 stroke-[4]"></i> : <i data-lucide="circle" className="w-7 h-7 opacity-20"></i>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {editingDate && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm" onClick={() => setEditingDate(null)}>
                            <div className="bg-white w-full max-w-xs p-8 rounded-[40px] animate-pop text-center shadow-2xl" onClick={e => e.stopPropagation()}>
                                <p className="text-xl font-bold text-slate-700 mb-8">{editingDate.day}„Å´„Å° „ÅÆ „Åç„Çç„Åè</p>
                                <div className="space-y-3">
                                    <button onClick={() => updateHistoryManually(editingDate.key, 100)} className="w-full py-5 bg-orange-50 text-orange-600 font-bold rounded-2xl border-2 border-orange-200 text-lg">üíÆ „Åú„Çì„Å∂ „Åß„Åç„ÅüÔºÅ</button>
                                    <button onClick={() => updateHistoryManually(editingDate.key, 50)} className="w-full py-5 bg-green-50 text-green-600 font-bold rounded-2xl border-2 border-green-200">‚óè „ÅØ„Çì„Å∂„Çì „Åß„Åç„Åü</button>
                                    <button onClick={() => updateHistoryManually(editingDate.key, 0)} className="w-full py-5 bg-slate-50 text-slate-400 font-bold rounded-2xl">„Åæ„Å† / „ÇØ„É™„Ç¢</button>
                                    <button onClick={() => setEditingDate(null)} className="w-full py-3 text-slate-300 text-sm mt-4">„ÇÇ„Å©„Çã</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfetti && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6" onClick={() => setShowConfetti(false)}>
                            <div className="bg-white w-full max-w-xs p-10 rounded-[50px] text-center animate-pop shadow-2xl">
                                <div className="text-7xl mb-6">üíÆ</div>
                                <h2 className="text-4xl font-black text-sky-600 mb-2">„Åô„Åî„Éº„ÅÑÔºÅ</h2>
                                <p className="font-bold text-slate-500 mb-8 leading-relaxed">„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ<br/>„Å®„Å£„Å¶„ÇÇ „Åà„Çâ„ÅÑ„ÅûÔºÅ</p>
                                <button onClick={() => setShowConfetti(false)} className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-black py-5 rounded-[25px] shadow-lg active:scale-95 transition-all text-xl">„ÇÑ„Å£„Åü„ÉºÔºÅ</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
