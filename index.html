<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åä„Åó„Åü„Åè„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const App = () => {
            // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
            const [tasks, setTasks] = useState([]);
            const [history, setHistory] = useState({});
            const [activeTab, setActiveTab] = useState('morning');
            const [view, setView] = useState('main'); // 'main', 'stats', 'edit'
            const [showConfetti, setShowConfetti] = useState(false);
            const [editingDate, setEditingDate] = useState(null);
            
            // Êñ∞Ë¶è„Çø„Çπ„ÇØÁî®
            const [newTaskText, setNewTaskText] = useState('');
            const [newTaskIcon, setNewTaskIcon] = useState('‚ú®');
            const iconOptions = ['‚ú®', 'üí¶', 'ü™•', 'üëï', 'üöΩ', 'üçö', 'üßº', 'üõÅ', 'üõå', 'üìö', 'üéí', 'üëü', '‚úèÔ∏è', 'üçé'];

            // --- ‰æøÂà©Èñ¢Êï∞ ---
            const getTodayStr = () => new Date().toDateString();
            const getTodayKey = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            };
            const getProperTab = useCallback(() => {
                const hour = new Date().getHours();
                return (hour >= 5 && hour < 15) ? 'morning' : 'evening';
            }, []);

            // --- ÂàùÊúü„Éá„Éº„ÇøË™≠„ÅøËæº„Åø ---
            useEffect(() => {
                const savedTasks = localStorage.getItem('kidsTasksV6');
                const savedHistory = localStorage.getItem('kidsHistoryV6');
                const savedDate = localStorage.getItem('taskDateV6');
                const todayStr = getTodayStr();

                if (savedTasks) {
                    const parsed = JSON.parse(savedTasks);
                    setTasks(savedDate !== todayStr ? parsed.map(t => ({ ...t, done: false })) : parsed);
                } else {
                    setTasks([
                        { id: '1', text: '„Åã„Åä„Çí„ÅÇ„Çâ„ÅÜ', icon: 'üí¶', time: 'morning', done: false },
                        { id: '2', text: '„ÅØ„Åø„Åå„Åç', icon: 'ü™•', time: 'morning', done: false },
                        { id: '3', text: '„Åä„Åµ„Çç', icon: 'üõÅ', time: 'evening', done: false },
                        { id: '4', text: '„Åó„ÇÖ„Åè„Å†„ÅÑ', icon: 'üìö', time: 'evening', done: false }
                    ]);
                }
                if (savedHistory) setHistory(JSON.parse(savedHistory));
                localStorage.setItem('taskDateV6', todayStr);
                setActiveTab(getProperTab());
            }, []);

            // --- Ëá™ÂãïÊõ¥Êñ∞„ÉÅ„Çß„ÉÉ„ÇØ (1ÂàÜ„Åä„Åç & „Éï„Ç©„Éº„Ç´„ÇπÊôÇ) ---
            const refreshAppState = useCallback(() => {
                const todayStr = getTodayStr();
                const savedDate = localStorage.getItem('taskDateV6');
                const targetTab = getProperTab();

                if (savedDate !== todayStr) {
                    setTasks(prev => prev.map(t => ({ ...t, done: false })));
                    localStorage.setItem('taskDateV6', todayStr);
                }
                setActiveTab(prev => (prev !== targetTab ? targetTab : prev));
            }, [getProperTab]);

            useEffect(() => {
                const timer = setInterval(refreshAppState, 60000);
                window.addEventListener('focus', refreshAppState);
                return () => {
                    clearInterval(timer);
                    window.removeEventListener('focus', refreshAppState);
                };
            }, [refreshAppState]);

            // --- ‰øùÂ≠òÂá¶ÁêÜ ---
            useEffect(() => {
                if (tasks.length > 0) {
                    localStorage.setItem('kidsTasksV6', JSON.stringify(tasks));
                    const currentTabTasks = tasks.filter(t => t.time === activeTab);
                    if (currentTabTasks.length > 0) {
                        const done = currentTabTasks.filter(t => t.done).length;
                        const percent = Math.round((done / currentTabTasks.length) * 100);
                        // Êú¨Êó•„ÅÆÈÄ≤Êçó„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠òÔºàÊúùÂ§ï„Å©„Å°„Çâ„Åã„ÅÆÈÄ≤Êçó„ÇíÂèçÊò†Ôºâ
                        const newHistory = { ...history, [getTodayKey()]: percent };
                        setHistory(newHistory);
                        localStorage.setItem('kidsHistoryV6', JSON.stringify(newHistory));
                    }
                }
            }, [tasks]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [view, activeTab, tasks, editingDate]);

            // --- „Ç¢„ÇØ„Ç∑„Éß„É≥ ---
            const toggleTask = (id) => {
                const newTasks = tasks.map(t => t.id === id ? { ...t, done: !t.done } : t);
                const currentTasks = tasks.filter(t => t.time === activeTab);
                const isNowComplete = newTasks.filter(t => t.time === activeTab).every(t => t.done);
                const wasComplete = currentTasks.every(t => t.done);
                
                if (isNowComplete && !wasComplete && currentTasks.length > 0) setShowConfetti(true);
                setTasks(newTasks);
            };

            const addTask = (time) => {
                if (!newTaskText.trim()) return;
                const newTask = { id: Date.now().toString(), text: newTaskText, icon: newTaskIcon, time, done: false };
                setTasks([...tasks, newTask]);
                setNewTaskText('');
            };

            const deleteTask = (id) => {
                if (confirm('„Åë„Åó„Å¶„ÇÇ „ÅÑ„ÅÑÔºü')) setTasks(tasks.filter(t => t.id !== id));
            };

            const updateHistoryManually = (dateStr, percent) => {
                const newHistory = { ...history, [dateStr]: percent };
                setHistory(newHistory);
                localStorage.setItem('kidsHistoryV6', JSON.stringify(newHistory));
                setEditingDate(null);
            };

            // --- „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà: ÂÆüÁ∏æÁîªÈù¢ ---
            const StatsView = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                
                return (
                    <div className="p-4 space-y-6 animate-pop pb-24">
                        <div className="flex justify-between items-center">
                            <button onClick={() => setView('main')} className="p-2 bg-white rounded-full shadow-md"><i data-lucide="chevron-left"></i></button>
                            <h2 className="text-xl font-bold text-purple-600">„Åå„Çì„Å∞„Çä„Å≤„Çá„ÅÜ</h2>
                            <div className="w-10"></div>
                        </div>
                        <div className="bg-white rounded-3xl p-5 shadow-sm border-b-4 border-green-100">
                            <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase">Calendar (Tap to Edit)</h3>
                            <div className="calendar-grid">
                                {['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'].map(d => <div key={d} className="text-center text-[10px] text-slate-300">{d}</div>)}
                                {Array(firstDay).fill(null).map((_, i) => <div key={`e-${i}`}></div>)}
                                {Array(days).fill(null).map((_, i) => {
                                    const day = i + 1;
                                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const p = history[dStr] || 0;
                                    return (
                                        <div key={day} onClick={() => setEditingDate({dStr, day})} className="aspect-square rounded-xl flex items-center justify-center relative border border-slate-50 active:scale-90 transition-all">
                                            <span className="text-[10px] text-slate-400">{day}</span>
                                            {p === 100 && <div className="absolute inset-0 flex items-center justify-center text-orange-400 text-lg">üíÆ</div>}
                                            {p > 0 && p < 100 && <div className="absolute bottom-1 w-1 h-1 bg-green-300 rounded-full"></div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            const currentList = tasks.filter(t => t.time === activeTab);
            const progress = currentList.length > 0 ? Math.round((currentList.filter(t => t.done).length / currentList.length) * 100) : 0;

            return (
                <div className="min-h-screen bg-slate-50 select-none">
                    {view === 'stats' ? <StatsView /> : view === 'edit' ? (
                        <div className="p-4 animate-pop pb-24">
                            <div className="flex justify-between items-center mb-6">
                                <button onClick={() => setView('main')} className="p-2 bg-white rounded-full shadow-md"><i data-lucide="chevron-left"></i></button>
                                <h2 className="text-xl font-bold text-sky-600">„Åõ„Å£„Å¶„ÅÑ</h2>
                                <div className="w-10"></div>
                            </div>
                            <div className="bg-white p-5 rounded-[32px] shadow-sm mb-6">
                                <input type="text" value={newTaskText} onChange={e => setNewTaskText(e.target.value)} placeholder="„Å™„Å´„Çí„Åô„ÇãÔºü" className="w-full p-4 rounded-2xl bg-slate-50 mb-4 outline-none border-2 border-transparent focus:border-sky-300" />
                                <div className="flex gap-2 overflow-x-auto mb-4 scrollbar-hide pb-2">
                                    {iconOptions.map(icon => <button key={icon} onClick={() => setNewTaskIcon(icon)} className={`text-2xl p-3 rounded-2xl ${newTaskIcon === icon ? 'bg-sky-100 ring-2 ring-sky-300' : 'bg-slate-50'}`}>{icon}</button>)}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => addTask('morning')} className="flex-1 py-4 bg-sky-400 text-white font-bold rounded-2xl">„ÅÇ„Åï„Å´ËøΩÂä†</button>
                                    <button onClick={() => addTask('evening')} className="flex-1 py-4 bg-purple-400 text-white font-bold rounded-2xl">„Çà„Çã„Å´ËøΩÂä†</button>
                                </div>
                            </div>
                            <div className="space-y-3">
                                {tasks.map(t => (
                                    <div key={t.id} className="flex items-center gap-3 bg-white p-4 rounded-2xl shadow-sm">
                                        <span className="text-2xl">{t.icon}</span>
                                        <span className="flex-1 font-bold text-slate-600">{t.text} <span className="text-[10px] text-slate-300">({t.time === 'morning' ? '„ÅÇ„Åï' : '„Çà„Çã'})</span></span>
                                        <button onClick={() => deleteTask(t.id)} className="text-red-400 p-2"><i data-lucide="trash-2"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="pb-24">
                            <div className={`p-4 shadow-lg sticky top-0 z-10 rounded-b-[40px] transition-colors safe-area-top ${activeTab === 'morning' ? 'bg-sky-400' : 'bg-purple-400'}`}>
                                <div className="flex justify-between items-center text-white mb-3">
                                    <h1 className="text-xl font-bold flex items-center gap-2"><i data-lucide="star" className="fill-yellow-300 text-yellow-300"></i>„Åä„Åó„Åü„Åè„Çπ„Çø„Éº</h1>
                                    <div className="flex gap-2">
                                        <button onClick={() => setView('stats')} className="p-2 bg-white/20 rounded-full"><i data-lucide="trophy"></i></button>
                                        <button onClick={() => setView('edit')} className="p-2 bg-white/20 rounded-full"><i data-lucide="settings"></i></button>
                                    </div>
                                </div>
                                <div className="bg-white/30 rounded-full h-4 overflow-hidden border border-white/10"><div className="bg-yellow-300 h-full transition-all duration-700" style={{ width: `${progress}%` }} /></div>
                            </div>

                            <div className="flex gap-4 my-6 px-6">
                                <button onClick={() => setActiveTab('morning')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'morning' ? 'bg-sky-50 border-sky-400 text-sky-600 font-bold scale-105 shadow-sm' : 'bg-white border-transparent text-slate-300'}`}>„ÅÇ„Åï</button>
                                <button onClick={() => setActiveTab('evening')} className={`flex-1 py-4 rounded-3xl border-2 transition-all ${activeTab === 'evening' ? 'bg-purple-50 border-purple-400 text-purple-600 font-bold scale-105 shadow-sm' : 'bg-white border-transparent text-slate-300'}`}>„Çà„Çã</button>
                            </div>

                            <div className="px-4 space-y-4 max-w-md mx-auto">
                                {currentList.map(task => (
                                    <div key={task.id} onClick={() => toggleTask(task.id)} className={`p-5 rounded-[32px] flex items-center gap-4 bg-white shadow-sm border-b-4 border-slate-200 active:scale-95 transition-all ${task.done ? 'opacity-60 bg-green-50' : ''}`}>
                                        <div className="text-4xl bg-slate-50 w-14 h-14 rounded-2xl flex items-center justify-center">{task.icon}</div>
                                        <div className={`flex-1 font-bold text-lg ${task.done ? 'line-through text-green-700' : 'text-slate-700'}`}>{task.text}</div>
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center ${task.done ? 'bg-green-500 text-white shadow-lg' : 'bg-slate-100 text-slate-200'}`}>
                                            {task.done ? <i data-lucide="check" className="w-7 h-7 stroke-[4]"></i> : <i data-lucide="circle"></i>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* „É¢„Éº„ÉÄ„É´È°û */}
                    {editingDate && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm" onClick={() => setEditingDate(null)}>
                            <div className="bg-white w-full max-w-xs p-6 rounded-[40px] animate-pop text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-slate-600 mb-6">{editingDate.day}„Å´„Å° „ÅÆË®òÈå≤</h3>
                                <div className="space-y-3">
                                    <button onClick={() => updateHistoryManually(editingDate.dStr, 100)} className="w-full py-4 bg-orange-50 text-orange-600 font-bold rounded-2xl border-2 border-orange-200">üíÆ „Åú„Çì„Å∂ „Åß„Åç„ÅüÔºÅ</button>
                                    <button onClick={() => updateHistoryManually(editingDate.dStr, 50)} className="w-full py-4 bg-green-50 text-green-600 font-bold rounded-2xl border-2 border-green-200">‚óè „ÅØ„Çì„Å∂„Çì „Åß„Åç„Åü</button>
                                    <button onClick={() => updateHistoryManually(editingDate.dStr, 0)} className="w-full py-4 bg-slate-50 text-slate-400 font-bold rounded-2xl">„Åæ„Å† / „ÇØ„É™„Ç¢</button>
                                    <button onClick={() => setEditingDate(null)} className="w-full py-3 text-slate-400 text-sm">„ÇÇ„Å©„Çã</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showConfetti && (
                        <div className="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-6" onClick={() => setShowConfetti(false)}>
                            <div className="bg-white w-full max-w-xs p-10 rounded-[50px] text-center animate-pop shadow-2xl">
                                <div className="text-6xl mb-4">üíÆ</div>
                                <h2 className="text-3xl font-black text-sky-600 mb-2">„Åô„Åî„Éº„ÅÑÔºÅ</h2>
                                <p className="font-bold text-slate-500 mb-8">„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ</p>
                                <button onClick={() => setShowConfetti(false)} className="w-full bg-yellow-400 text-white font-black py-4 rounded-2xl shadow-lg">„ÇÑ„Å£„Åü„ÉºÔºÅ</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
